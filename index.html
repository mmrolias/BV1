<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>The Bridge â€“ 1.0.8</title>

<style>
:root{
  --bg:#07080b;
  --ink:#e8e9ee;
  --muted:#a9adbb;
  --accent:#7dd3fc;
  --danger:#ff5c7a;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --radius:16px;
}

*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(180deg,#05060a,#0b1020);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

.hidden{display:none}

.startScreen{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  padding:
    max(24px, env(safe-area-inset-top))
    18px
    max(24px, env(safe-area-inset-bottom));
  background:linear-gradient(180deg,#04050a,#0b1020);
  z-index:10;
}

.startCard{
  max-width:880px;
  width:100%;
  border:1px solid var(--border);
  border-radius:20px;
  background:rgba(0,0,0,.4);
  padding:22px;
}

.startCard h1{
  margin:0 0 10px;
  font-size:clamp(28px,5vw,44px);
}

.startCard p{
  color:var(--muted);
  line-height:1.6;
}

button{
  border:1px solid var(--border);
  background:#10162d;
  color:var(--ink);
  padding:10px 14px;
  border-radius:14px;
  cursor:pointer;
}

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:20px 16px 80px;
}

.grid{
  display:grid;
  gap:16px;
}

@media(min-width:900px){
  .grid{grid-template-columns:360px 1fr}
}

.panel{
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:var(--card);
  padding:12px;
}

#story{
  min-height:320px;
}

</style>
</head>

<body>

<!-- INTRO -->
<div class="startScreen" id="startScreen">
  <div class="startCard">
    <h1>The Bridge</h1>
    <p id="introText"></p>
    <div style="margin-top:16px;display:flex;gap:10px">
      <button id="startBtn">Start</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>
</div>

<!-- GAME UI -->
<div class="wrap">
  <section class="grid">
    <aside class="panel">
      <h3>Status</h3>
      <div id="stats"></div>

      <h3>Inventory</h3>
      <div id="inventory"></div>
    </aside>

    <main class="panel" id="story">
      <h2 id="sceneTitle"></h2>
      <p id="sceneText"></p>
      <div id="combat"></div>
      <div id="choices"></div>
    </main>
  </section>
</div>

<script>
(function(){
"use strict";

const STORAGE_KEY = "the_bridge_1_0_8";

const INTRO = `Some places are built to last.
Some places are built to keep you.

In the Village of Immortals, death is a myth you study like an old language.
To prevent the village from overflowing, the Council enforces one rule:
Every year, two must cross the Bridge.

The Bridge is stone, massive, and wrong.
It looks suspended over nothing, but columns sink into fog like drowned towers.

Almost no one returns.
Exactly one did, once: old, blind, deaf, and mute.

Tonight, the Council speaks your name.`;

const $ = (id)=>document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const roll = (sides)=>randInt(1,sides);

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* Inject extra CSS for combat cards, dice, shake, sprites */
(function injectCss(){
  const css = `
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{
    border:1px solid var(--border);
    background:rgba(0,0,0,.22);
    border-radius:16px;
    padding:12px;
    margin-top:10px;
  }
  .choiceBtn{
    width:100%;
    text-align:left;
    margin-top:10px;
    padding:12px;
    border-radius:16px;
    border:1px solid var(--border);
    background:rgba(16,22,45,.9);
  }
  .choiceBtn:active{transform:translateY(1px)}
  .hpBar{
    height:10px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
  }
  .hpFill{
    height:100%;
    width:50%;
    background:linear-gradient(90deg, rgba(125,211,252,.95), rgba(118,255,178,.85));
    transition:width .2s ease;
  }
  .hpFill.danger{
    background:linear-gradient(90deg, rgba(255,92,122,.95), rgba(255,211,108,.85));
  }
  .shake{animation:shk 220ms ease-in-out}
  @keyframes shk{
    0%{transform:translateX(0)}
    20%{transform:translateX(-6px)}
    40%{transform:translateX(6px)}
    60%{transform:translateX(-4px)}
    80%{transform:translateX(4px)}
    100%{transform:translateX(0)}
  }
  .diceBox{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .die{
    min-width:96px;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
    text-align:center;
  }
  .die .lbl{font-size:11px;color:var(--muted);text-transform:uppercase}
  .die .num{font-size:24px;font-weight:800;margin-top:2px}
  .num.enemy{color:var(--danger)}
  .num.good{color:rgba(118,255,178,.95)}
  .crit{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,211,108,.35);
    background:rgba(255,211,108,.12);
    color:rgba(255,211,108,.95);
    font-weight:900;
    letter-spacing:.6px;
    text-transform:uppercase;
    font-size:11px;
    opacity:0;
    transform:scale(.92);
    transition:opacity .12s ease, transform .12s ease;
  }
  .crit.show{opacity:1;transform:scale(1)}
  .spriteBox{
    width:96px;height:96px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.25);
    display:grid;
    place-items:center;
    overflow:hidden;
  }
  .enemyTop{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:flex-start;
    justify-content:space-between;
  }
  .enemyMeta{font-size:12px;color:var(--muted);line-height:1.35}
  .invItem{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
    padding:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    margin-top:10px;
  }
  .invLeft{display:flex;gap:10px;align-items:flex-start}
  .rar{font-size:10px;text-transform:uppercase;letter-spacing:.6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
  .rar.common{border-color:rgba(147,197,253,.22);color:rgba(147,197,253,.95)}
  .rar.uncommon{border-color:rgba(167,243,208,.22);color:rgba(167,243,208,.95)}
  .rar.rare{border-color:rgba(196,181,253,.22);color:rgba(196,181,253,.95)}
  .rar.legendary{border-color:rgba(255,211,108,.28);color:rgba(255,211,108,.95)}
  .smallBtn{padding:8px 10px;border-radius:12px}
  `;
  const style = document.createElement("style");
  style.textContent = css;
  document.head.appendChild(style);
})();

/* Pixel helpers stubs (Part 3 will replace with colored versions) */
window.renderWeaponIcon = window.renderWeaponIcon || function(weaponId){
  const d = document.createElement("div");
  d.style.width = "34px";
  d.style.height = "34px";
  d.style.borderRadius = "10px";
  d.style.border = "1px solid rgba(255,255,255,.12)";
  d.style.background = "rgba(125,211,252,.10)";
  d.style.display = "grid";
  d.style.placeItems = "center";
  d.style.fontWeight = "900";
  d.style.color = "rgba(125,211,252,.9)";
  d.textContent = (weaponId||"?")[0].toUpperCase();
  return d;
};

window.renderEnemySprite = window.renderEnemySprite || function(enemyId, mount){
  mount.innerHTML = "";
  const d = document.createElement("div");
  d.style.width = "88px";
  d.style.height = "88px";
  d.style.borderRadius = "12px";
  d.style.background = "rgba(255,92,122,.10)";
  d.style.border = "1px solid rgba(255,255,255,.10)";
  d.style.display = "grid";
  d.style.placeItems = "center";
  d.style.fontWeight = "900";
  d.style.color = "rgba(255,92,122,.95)";
  d.textContent = (enemyId||"ENEMY").slice(0,2).toUpperCase();
  mount.appendChild(d);
};

function animateNumber(el, finalVal, durationMs, min, max){
  const start = performance.now();
  const span = max - min;
  let raf = 0;
  function tick(t){
    const p = clamp((t - start)/durationMs, 0, 1);
    if(p < 1){
      const v = min + Math.floor(Math.random() * (span + 1));
      el.textContent = String(v);
      raf = requestAnimationFrame(tick);
    } else {
      el.textContent = String(finalVal);
    }
  }
  cancelAnimationFrame(raf);
  raf = requestAnimationFrame(tick);
}

const WEAPONS = {
  iron_sword:{ id:"iron_sword", name:"Iron Sword", rarity:"common", dmg:"1d8+1", hit:+2, dur:18, desc:"Reliable steel. Familiar weight." },
  oak_club:{ id:"oak_club", name:"Oak Club", rarity:"common", dmg:"1d10", hit:+1, dur:16, desc:"Crude, stubborn, honest." },
  chipped_spear:{ id:"chipped_spear", name:"Chipped Spear", rarity:"common", dmg:"1d8+2", hit:+1, dur:14, desc:"Reach matters on narrow stone." },
  river_knife:{ id:"river_knife", name:"River Knife", rarity:"common", dmg:"1d6+2", hit:+3, dur:12, desc:"Quick, cold, impatient." },

  fog_dagger:{ id:"fog_dagger", name:"Fog Dagger", rarity:"uncommon", dmg:"1d6+3", hit:+3, dur:14, desc:"A thin blade colder than air." },
  stone_maul:{ id:"stone_maul", name:"Stone Maul", rarity:"uncommon", dmg:"1d12", hit:+1, dur:12, desc:"Heavy, blunt, loud." },

  glass_sabre:{ id:"glass_sabre", name:"Glass Sabre", rarity:"rare", dmg:"2d4+3", hit:+4, dur:8, desc:"Beautiful. Breaks like a promise." },
  council_needle:{ id:"council_needle", name:"Council Needle", rarity:"rare", dmg:"1d10+2", hit:+5, dur:10, desc:"Not a weapon, a verdict." },

  bridgeheart_relic:{ id:"bridgeheart_relic", name:"Bridgeheart Relic", rarity:"legendary", dmg:"2d10+2", hit:+6, dur:16, desc:"A blade made from the Bridge's memory." }
};

const COMMON_POOL = ["oak_club","chipped_spear","river_knife"];

const ENEMIES = {
  batling:{ id:"batling", name:"Batling", hp:14, ac:12, hit:+3, dmg:"1d6+2", threat:1, desc:"A winged mistake with teeth." },
  mist_mirror:{ id:"mist_mirror", name:"Mist Mirror", hp:18, ac:13, hit:+4, dmg:"1d6+3", threat:2, desc:"Looks like you, with wrong timing." },
  hollow_warden:{ id:"hollow_warden", name:"Hollow Warden", hp:26, ac:12, hit:+4, dmg:"1d8+3", threat:3, desc:"Armor with nobody inside. Still has authority." },
  stone_scribe:{ id:"stone_scribe", name:"Stone Scribe", hp:22, ac:11, hit:+2, dmg:"1d10", threat:3, desc:"Carves marks into stone using bone." }
};

const DEFAULT = {
  hp:100, energy:100, resolve:50,
  supplies:{ bread:1, water:1, salve:0 },
  weapons:[],
  equipped:"",
  weaponDur:{},
  flags:{
    tookSeamLoot:false,
    tookDoorLoot:false,
    tookPedestalLoot:false,
    hasAshCoin:false,
    listenedArch:false,
    secretTried:false,
    returnedSeen:false,
    returnedMet:false
  },
  scene:"s_intro",
  log:[],
  combat:null,
  postCombat:null
};

let S = load() || deepClone(DEFAULT);
bootNormalize();

function bootNormalize(){
  $("introText").textContent = INTRO;

  // Ensure two starting weapons: iron sword + random common
  if(!Array.isArray(S.weapons)) S.weapons = [];
  if(!S.weaponDur) S.weaponDur = {};
  if(!S.supplies) S.supplies = { bread:1, water:1, salve:0 };
  if(!S.flags) S.flags = deepClone(DEFAULT.flags);

  if(S.weapons.length === 0){
    const second = COMMON_POOL[randInt(0, COMMON_POOL.length-1)];
    S.weapons = ["iron_sword", second];
    S.equipped = "iron_sword";
    S.weaponDur["iron_sword"] = WEAPONS.iron_sword.dur;
    S.weaponDur[second] = WEAPONS[second].dur;
    S.log = ["The wind is still. In the Village, that is always the first omen."];
    save();
  }

  if(!S.equipped || !S.weapons.includes(S.equipped)){
    S.equipped = S.weapons[0] || "iron_sword";
  }
  S.weapons.forEach(id=>{
    if(typeof S.weaponDur[id] !== "number"){
      S.weaponDur[id] = WEAPONS[id] ? WEAPONS[id].dur : 0;
    }
  });
}

/* Save / Load */
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }catch(e){} }
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

/* UI helpers */
function addLog(line){
  S.log.push(line);
  if(S.log.length > 140) S.log.shift();
  renderStats();
  save();
}

function shakeStory(){
  const st = $("story");
  st.classList.remove("shake");
  void st.offsetWidth;
  st.classList.add("shake");
  setTimeout(()=>st.classList.remove("shake"), 260);
}

function setStat(key, delta){
  if(key==="hp") S.hp = clamp(S.hp+delta, 0, 100);
  if(key==="energy") S.energy = clamp(S.energy+delta, 0, 100);
  if(key==="resolve") S.resolve = clamp(S.resolve+delta, 0, 100);
}

function currentWeapon(){
  const w = WEAPONS[S.equipped] || WEAPONS.iron_sword;
  const curDur = typeof S.weaponDur[w.id] === "number" ? S.weaponDur[w.id] : w.dur;
  return { ...w, curDur };
}
function weaponToHit(w){
  const broken = (w.curDur<=0) ? -3 : 0;
  return (w.hit||0) + broken;
}
function decDur(id, amt){
  const w = WEAPONS[id];
  if(!w) return;
  const base = w.dur;
  const cur = typeof S.weaponDur[id] === "number" ? S.weaponDur[id] : base;
  S.weaponDur[id] = clamp(cur-amt, 0, base);
}

/* Render stats and inventory */
function renderStats(){
  const stats = $("stats");
  const inv = $("inventory");

  const w = currentWeapon();
  const toHit = weaponToHit(w);

  stats.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Health</strong> <span class="muted">${S.hp}/100</span></div>
      </div>
      <div class="hpBar"><div class="hpFill danger" style="width:${S.hp}%"></div></div>

      <div style="height:10px"></div>

      <div class="row" style="justify-content:space-between">
        <div><strong>Energy</strong> <span class="muted">${S.energy}/100</span></div>
      </div>
      <div class="hpBar"><div class="hpFill" style="width:${S.energy}%"></div></div>

      <div style="height:10px"></div>

      <div class="row" style="justify-content:space-between">
        <div><strong>Resolve</strong> <span class="muted">${S.resolve}/100</span></div>
      </div>
      <div class="hpBar"><div class="hpFill" style="width:${S.resolve}%"></div></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Supplies</strong></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="smallBtn" id="useBread">Bread x${S.supplies.bread||0}</button>
        <button class="smallBtn" id="useWater">Water x${S.supplies.water||0}</button>
        <button class="smallBtn" id="useSalve">Salve x${S.supplies.salve||0}</button>
      </div>
      <div class="muted" style="margin-top:8px;font-size:12px;line-height:1.4">
        Bread restores energy and a bit of resolve. Water restores health. Salve is emergency healing.
      </div>
    </div>

    <div class="card">
      <div><strong>Recent</strong></div>
      <div class="muted" style="white-space:pre-wrap;font-size:12px;line-height:1.5;margin-top:8px">${S.log.slice(-10).join("\n")}</div>
    </div>
  `;

  inv.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <strong>Equipped</strong><div class="muted" style="font-size:12px;margin-top:2px">${w.name}</div>
          <div class="muted" style="font-size:12px;margin-top:6px">DMG ${w.dmg} | HIT ${toHit>=0? "+"+toHit:toHit} | DUR ${w.curDur}</div>
        </div>
        <span class="rar ${w.rarity}">${w.rarity}</span>
      </div>
    </div>

    <div class="card">
      <div><strong>Weapons</strong> <span class="muted" style="font-size:12px">(${S.weapons.length})</span></div>
      <div id="weaponList"></div>
    </div>
  `;

  const list = $("weaponList");
  list.innerHTML = "";
  S.weapons.forEach(id=>{
    const ww = WEAPONS[id];
    if(!ww) return;
    const cur = typeof S.weaponDur[id] === "number" ? S.weaponDur[id] : ww.dur;
    const isEq = (id === S.equipped);

    const row = document.createElement("div");
    row.className = "invItem";

    const left = document.createElement("div");
    left.className = "invLeft";

    const icon = window.renderWeaponIcon(id);

    const text = document.createElement("div");
    text.innerHTML = `
      <div class="row" style="gap:8px">
        <strong>${ww.name}${isEq ? " (equipped)" : ""}</strong>
        <span class="rar ${ww.rarity}">${ww.rarity}</span>
      </div>
      <div class="muted" style="font-size:12px;margin-top:4px;line-height:1.35">
        DMG ${ww.dmg} | HIT ${ww.hit>=0? "+"+ww.hit:ww.hit} | DUR ${cur}
      </div>
      <div class="muted" style="font-size:12px;margin-top:4px;line-height:1.35">${ww.desc}</div>
    `;
    left.appendChild(icon);
    left.appendChild(text);

    const right = document.createElement("div");
    right.className = "row";
    right.style.justifyContent = "flex-end";

    const btn = document.createElement("button");
    btn.className = "smallBtn";
    btn.textContent = isEq ? "Equipped" : "Equip";
    btn.disabled = isEq;
    btn.addEventListener("click", ()=>{
      S.equipped = id;
      addLog(`Equipped: ${ww.name}.`);
      save();
      renderAll();
    });

    right.appendChild(btn);
    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });

  $("useBread").disabled = (S.supplies.bread||0) <= 0;
  $("useWater").disabled = (S.supplies.water||0) <= 0;
  $("useSalve").disabled = (S.supplies.salve||0) <= 0;

  $("useBread").onclick = ()=>{
    if((S.supplies.bread||0)<=0) return;
    S.supplies.bread--;
    setStat("energy", +18);
    setStat("resolve", +4);
    addLog("You eat bread. Your body remembers being mortal.");
    save(); renderAll();
  };
  $("useWater").onclick = ()=>{
    if((S.supplies.water||0)<=0) return;
    S.supplies.water--;
    setStat("hp", +16);
    setStat("energy", +8);
    addLog("You drink water. Stone feels less hungry.");
    save(); renderAll();
  };
  $("useSalve").onclick = ()=>{
    if((S.supplies.salve||0)<=0) return;
    S.supplies.salve--;
    setStat("hp", +28);
    addLog("You apply salve. Pain steps back.");
    save(); renderAll();
  };
}

/* Loot helpers */
function gainWeapon(id){
  const w = WEAPONS[id];
  if(!w) return;
  if(S.weapons.includes(id)){
    addLog(`You found ${w.name} again, but you already carry it.`);
    return;
  }
  S.weapons.push(id);
  S.weaponDur[id] = w.dur;
  addLog(`You obtained: ${w.name}.`);
}
function gainSupply(kind, qty, line){
  S.supplies[kind] = (S.supplies[kind]||0) + qty;
  addLog(line || `You gained ${kind} x${qty}.`);
}

/* Scenes */
const SCENES = {
  s_intro:{
    title:"The Village That Outlasts Meaning",
    text:()=>`Urgency is treated as a mortal habit.\n\nThe Council enforces one rule:\nEvery year, two must cross the Bridge.\n\nTonight, your name is chosen.`,
    choices:[
      { label:"Go to the Council Hall", hint:"Your life becomes a procedure.", to:"s_council" }
    ]
  },

  s_council:{
    title:"Council Hall, Under Perfect Lamps",
    text:()=>`Two will cross. No exceptions.\n\nA custodian watches you like a bracket in a sentence.\nThe other chosen stands near the door, too quiet.\n\nThe Bridge is not described as danger.\nIt is described as maintenance.`,
    choices:[
      { label:"Follow procedure to the gate", hint:"No more delays.", to:"s_gate",
        effect:()=>{ setStat("resolve", +2); addLog("You swallow the urge to argue with eternity."); }
      },
      { label:"Attempt the impossible objection", hint:"Extremely unlikely secret ending.", to:"s_secret" }
    ]
  },

  s_secret:{
    title:"The Impossible Probability",
    text:()=>`You challenge the Rule.\nThe room tilts, as if reality is deciding whether you are allowed to be unique.\n\nHold your ground.\nThe odds are absurd.\nThat is the point.`,
    choices:[
      { label:"Hold your ground", hint:"A ridiculous roll of fate.", to:(s)=> (trySecret() ? "s_secret_win" : "s_gate") },
      { label:"Back down", hint:"Return to procedure.", to:"s_council",
        effect:()=>{ setStat("resolve",-3); addLog("You step back. The lamps stop staring."); }
      }
    ]
  },

  s_secret_win:{
    title:"SECRET ENDING: Exception Filed",
    text:()=>`The Rule bends.\nAn exception.\n\nYou are dismissed.\n\nFinal status\nHealth: ${S.hp}  Energy: ${S.energy}  Resolve: ${S.resolve}`,
    choices:[
      { label:"Reset", hint:"New run.", to:"__reset" }
    ]
  },

  s_gate:{
    title:"The Gate and the Fog",
    text:()=>`Night. The gate opens.\nThe Bridge waits beyond it, swallowing moonlight.\n\nThe stone is cold enough to make your head spin through your palm.\nColumns disappear into fog below.\n\nForward stops being a direction.\nIt becomes a decision.`,
    choices:[
      { label:"Step onto the Bridge", hint:"The Bridge learns your weight.", to:"s_first",
        effect:()=>{ setStat("energy",-2); addLog("Cold stone, immediate regret."); }
      }
    ]
  },

  s_first:{
    title:"Act I: The Bridge Learns Your Name",
    text:()=>`The Bridge is longer than it should be.\nFog lies to distance.\n\nYou notice:\n- a warm seam in the stone\n- an impossible door on bare rock\n- an arch that hums like speech held behind teeth\n\nThe Bridge behaves like architecture.\nFor now.`,
    choices:[
      { label:"Search the warm seam", hint:"One time only loot.", to:"s_first",
        when:()=>!S.flags.tookSeamLoot,
        effect:()=>seamLoot()
      },
      { label:"Approach the impossible door", hint:"A shortcut with a price.", to:"s_door" },
      { label:"Walk under the humming arch", hint:"Listen and the Bridge answers back.", to:"s_arch" },
      { label:"Push forward into thicker fog", hint:"Higher risk, faster progress.", to:"s_fogrun",
        effect:()=>{ setStat("energy",-5); addLog("You move fast. The fog resents it."); }
      }
    ]
  },

  s_door:{
    title:"The Door Standing Alone",
    text:()=>`A door. No walls.\nCarved into it: ENTER AND FORGET.\n\nWarmth leaks around the frame.\nThat is always a trap.`,
    choices:[
      { label:"Search around the doorframe", hint:"One time only loot.", to:"s_door",
        when:()=>!S.flags.tookDoorLoot,
        effect:()=>doorLoot()
      },
      { label:"Open the door", hint:"An ending that feels comfortable.", to:"s_forget_end",
        effect:()=>{ setStat("resolve",-6); addLog("Warmth is a bribe."); }
      },
      { label:"Refuse and move on", hint:"Harder path. Cleaner self.", to:"s_arch",
        effect:()=>{ setStat("resolve",+5); addLog("You refuse the anesthetic."); }
      }
    ]
  },

  s_forget_end:{
    title:"Ending: Enter and Forget",
    text:()=>`You return to warmth.\nYou live. You smile. You resume eternity.\n\nAnd yet, sometimes someone says a simple word and you do not understand it.\n\nFinal status\nHealth: ${S.hp}  Energy: ${S.energy}  Resolve: ${S.resolve}`,
    choices:[ { label:"Reset", hint:"New run.", to:"__reset" } ]
  },

  s_arch:{
    title:"The Listening Arch",
    text:()=>`Marks cover the arch.\nNot writing.\nNot quite.\n\nThe hum starts to match your breathing.\n\nUnder the arch, the Bridge becomes a question.`,
    choices:[
      { label:"Stand under it and listen", hint:"One time only. Knowledge can hurt.", to:"s_columns",
        when:()=>!S.flags.listenedArch,
        effect:()=>{ S.flags.listenedArch=true; setStat("energy",-2); setStat("resolve",+10); setStat("hp",-6); shakeStory(); addLog("A voice with no mouth teaches you fear."); }
      },
      { label:"Walk through without listening", hint:"Safer, but you remain blind.", to:"s_columns",
        effect:()=>{ setStat("resolve",-1); addLog("You refuse the answer."); }
      }
    ]
  },

  s_fogrun:{
    title:"Correction",
    text:()=>`The Bridge does not shout.\nIt corrects.\n\nStone rises like a lip and bites your momentum.\nYou fall.\nNot far.\nEnough.`,
    choices:[
      { label:"Get up, slower", hint:"Pain is punctuation here.", to:"s_columns",
        effect:()=>{ setStat("hp",-10); setStat("resolve",+3); shakeStory(); addLog("Pain is the Bridge's punctuation."); }
      }
    ]
  },

  s_columns:{
    title:"Act II: The Column Forest",
    text:()=>`Fog thins in bands.\nBelow: columns, countless, like a forest of stone trunks.\n\nSome are carved with faces.\nSome with hands.\nMost with names.\n\nThen you notice something worse:\nsome names are fresh.\n\nAhead: a platform with a broken pedestal.\nA coin of gray ash rests there.`,
    choices:[
      { label:"Inspect the pedestal", hint:"One time only loot.", to:"s_columns",
        when:()=>!S.flags.tookPedestalLoot,
        effect:()=>pedestalLoot()
      },
      { label:"Take the ash coin", hint:"It can twist later scenes.", to:"s_columns",
        when:()=>!S.flags.hasAshCoin,
        effect:()=>{ S.flags.hasAshCoin=true; setStat("resolve",-2); addLog("The coin feels like absence pretending to be metal."); }
      },
      { label:"Move on", hint:"Toward the Mirror Gallery.", to:"s_mirrors",
        effect:()=>{ setStat("energy",-2); addLog("You move on. The Bridge respects restraint, sometimes."); }
      }
    ]
  },

  s_mirrors:{
    title:"Act III: The Mirror Gallery",
    text:()=>`The Bridge narrows into a corridor of fog.\n\nReflections form.\nNot in glass.\nIn the fog itself.\n\nYou see yourself walking.\nThen standing still.\nThen returning, old, blind, deaf, and mute.\n\nThe reflections drift closer.`,
    choices:[
      { label:"Speak your name out loud", hint:"Bold. Can provoke hostility.", to:"s_mirrors",
        effect:()=>{ addLog("You speak your name. The fog repeats it wrong."); startCombat("mist_mirror","s_toll"); }
      },
      { label:"Stay silent and observe", hint:"Safer, but time turns sticky.", to:"s_toll",
        effect:()=>{ setStat("resolve",+3); addLog("Silence is also a statement."); maybeReturnedEvent("s_toll"); }
      },
      { label:"Cut through the fog", hint:"Direct approach. Combat risk.", to:"s_mirrors",
        effect:()=>{ setStat("energy",-3); addLog("You slash the fog. The fog bleeds into shapes."); startCombat("batling","s_toll"); }
      },
      { label:"Offer the ash coin (if you have it)", hint:"A weird bargain.", to:"s_toll",
        when:()=>S.flags.hasAshCoin,
        effect:()=>{ S.flags.hasAshCoin=false; setStat("hp",-8); shakeStory(); setStat("resolve",+8); addLog("The coin vanishes. Your ribs ache as if something was removed."); maybeReturnedEvent("s_toll"); }
      }
    ]
  },

  s_toll:{
    title:"Act IV: The Toll Station",
    text:()=>`A booth stands on the Bridge.\nNo walls connect to it.\nA toll station for a path that should be free.\n\nA clerk-shaped shadow holds a book of blank pages.\nIt speaks:\n"PAY IN NAME, OR PAY IN BLOOD."`,
    choices:[
      { label:"Pay in name", hint:"Safer, but you feel recorded.", to:"s_warden",
        effect:()=>{ setStat("resolve",-8); addLog("You offer a piece of yourself as currency."); }
      },
      { label:"Pay in blood", hint:"Pain, but your name stays yours.", to:"s_warden",
        effect:()=>{ setStat("hp",-12); shakeStory(); setStat("resolve",+3); addLog("Your blood vanishes. No stain. No evidence."); }
      },
      { label:"Refuse to pay", hint:"Combat.", to:"s_toll",
        effect:()=>{ setStat("resolve",+2); addLog("You refuse. The booth becomes a mouth."); startCombat("stone_scribe","s_warden"); }
      }
    ]
  },

  s_warden:{
    title:"Act V: The Hollow Warden",
    text:()=>`Between the columns, a shape rises.\nNot climbing.\nRising, as if pulled by authority itself.\n\nArmor with nobody inside.\nYet it still has posture, and rules.\n\nIt steps onto the stone.`,
    choices:[
      { label:"Fight", hint:"Hard combat.", to:"s_warden",
        effect:()=>{ startCombat("hollow_warden","s_final"); }
      },
      { label:"Try to slip past", hint:"A risky check.", to:"s_final",
        effect:()=>{ slipPast(); }
      }
    ]
  },

  s_final:{
    title:"Act VI: The Last Fog",
    text:()=>`The air changes. It smells like soil, not stone.\nA sign the exit exists.\n\nLight appears ahead in thin slices.\n\nA final question forms:\nDid you cross it, or did it file you into place?`,
    choices:[
      { label:"Exit", hint:"Reach an ending.", to:"s_cross_end",
        effect:()=>{ addLog("You step out of the fog."); }
      },
      { label:"Turn around", hint:"Not all returns are allowed.", to:"s_turn",
        effect:()=>{ setStat("resolve",-2); addLog("You turn. The Bridge pretends not to notice."); }
      },
      { label:"Reset", hint:"New run.", to:"__reset" }
    ]
  },

  s_turn:{
    title:"Turning Back",
    text:()=>`Behind you, the Bridge looks shorter.\nNot by a little.\nBy a lot.\n\nFar back, you see the Village gate.\nBut it is not open.\nIt is a painting of a gate, hung in fog.`,
    choices:[
      { label:"Walk toward the painted gate", hint:"An ending that feels procedural.", to:"s_return_end",
        effect:()=>{ setStat("resolve",-10); addLog("Paperwork reaches for you through fog."); }
      },
      { label:"Refuse and go forward", hint:"Keep yourself.", to:"s_final",
        effect:()=>{ setStat("resolve",+6); addLog("You refuse the trick."); }
      }
    ]
  },

  s_cross_end:{
    title:"Ending: Beyond the Bridge",
    text:()=>`Light is harsh, honest, mortal.\n\nFinal status\nHealth: ${S.hp}  Energy: ${S.energy}  Resolve: ${S.resolve}\n\nThe Bridge does not threaten you.\nIt simply remembers you.`,
    choices:[ { label:"Reset", hint:"New run.", to:"__reset" } ]
  },

  s_return_end:{
    title:"Ending: Returned, But Filed",
    text:()=>`You blink and you are back in the Village.\nEverything is clean.\nEverything is calm.\n\nThe Council nods like nothing unusual occurred.\n\nFinal status\nHealth: ${S.hp}  Energy: ${S.energy}  Resolve: ${S.resolve}\n\nYou returned.\nChanged.`,
    choices:[ { label:"Reset", hint:"New run.", to:"__reset" } ]
  },

  s_returned:{
    title:"The Returned One",
    text:()=>`An old figure stands on the stone, perfectly still.\nBlind eyes.\nA mouth that does not move.\n\nHe points at the Bridge beneath your feet.\nThen at you.\n\nA scratchy thought arrives inside your skull:\n"DO NOT LET IT WRITE YOU CLEAN."`,
    choices:[
      { label:"Take the relic he offers", hint:"Legendary weapon. Consequences.", to:"s_final",
        effect:()=>{
          if(!S.flags.returnedMet){
            gainWeapon("bridgeheart_relic");
            S.equipped = "bridgeheart_relic";
            S.flags.returnedMet = true;
            setStat("resolve",-6);
            setStat("energy",-6);
            addLog("You accept a gift from a forbidden outcome.");
          }
        }
      },
      { label:"Ask how to survive", hint:"Guidance, not power.", to:"s_final",
        effect:()=>{
          S.flags.returnedMet = true;
          setStat("resolve",+10);
          setStat("energy",-2);
          addLog("Survival is staying undefined.");
        }
      }
    ]
  }
};

function trySecret(){
  // very low chance, but still plausible
  // About 1/80 baseline, slightly better with high resolve
  const base = 80;
  const bonus = Math.floor((S.resolve - 50)/6);
  const target = clamp(base - bonus, 35, 120);
  return randInt(1, target) === 1;
}

/* One-shot loot that removes the option by setting flags */
function seamLoot(){
  S.flags.tookSeamLoot = true;
  setStat("energy",-4);
  const r = randInt(1,100);
  if(r<=35){
    gainSupply("water",1,"You found water sealed in a small flask. It tastes like a different year.");
    setStat("resolve",+2);
  }else if(r<=70){
    gainSupply("bread",1,"You found bread that tastes like yesterday, stubbornly fresh.");
    setStat("resolve",+2);
  }else if(r<=88){
    gainWeapon(randInt(0,1)===0 ? "fog_dagger" : "stone_maul");
    setStat("resolve",+4);
  }else{
    setStat("hp",-8);
    shakeStory();
    addLog("The seam cuts you like paper. The Bridge dislikes theft.");
  }
  save(); renderAll();
}
function doorLoot(){
  S.flags.tookDoorLoot = true;
  setStat("energy",-3);
  const r = randInt(1,100);
  if(r<=18){
    gainWeapon("council_needle");
    setStat("resolve",+6);
  }else if(r<=45){
    gainWeapon("glass_sabre");
    setStat("resolve",+4);
  }else{
    setStat("hp",-8);
    shakeStory();
    addLog("The metal bites you like a verdict.");
  }
  save(); renderAll();
}
function pedestalLoot(){
  S.flags.tookPedestalLoot = true;
  setStat("energy",-2);
  const r = randInt(1,100);
  if(r<=22){
    gainSupply("salve",1,"You found salve wrapped in cloth that smells faintly like pine.");
    setStat("resolve",+3);
  }else if(r<=55){
    gainSupply("water",1,"A flask. The water is still. That should not be possible.");
  }else if(r<=80){
    gainWeapon(randInt(0,1)===0 ? "fog_dagger" : "stone_maul");
  }else{
    gainSupply("bread",1,"Bread appears where bread should not be. The Bridge is mocking you.");
  }
  save(); renderAll();
}

/* Rare event 1/30 (more realistic) */
function maybeReturnedEvent(nextScene){
  if(S.flags.returnedSeen) return;
  // Gate it lightly so it feels earned
  const gate = (S.resolve >= 58) && (S.flags.listenedArch || S.flags.hasAshCoin);
  if(!gate) return;
  const chance = 30;
  if(randInt(1,chance) === 1){
    S.flags.returnedSeen = true;
    addLog("The fog hesitates. Something old is near.");
    S.scene = "s_returned";
    save(); renderAll();
    return;
  }
}

/* Render scene */
function renderScene(){
  const sc = SCENES[S.scene];
  if(!sc){
    S.scene = "s_intro";
    save();
    return renderScene();
  }

  $("sceneTitle").textContent = sc.title;
  $("sceneText").textContent = sc.text(S);

  const choices = $("choices");
  choices.innerHTML = "";

  // Post combat continue
  if(S.postCombat){
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.textContent = "Continue";
    btn.onclick = ()=>{
      const next = S.postCombat.next;
      const note = S.postCombat.note;
      S.postCombat = null;
      addLog(note || "You continue.");
      save();
      if(next) go(next);
      else renderAll();
    };
    choices.appendChild(btn);
    return;
  }

  // If combat active, render combat only
  if(S.combat && S.combat.active){
    renderCombatUI();
    return;
  } else {
    $("combat").innerHTML = "";
  }

  const list = sc.choices || [];
  list.forEach((c)=>{
    if(c.when && !c.when(S)) return;

    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.innerHTML = `<strong>${c.label}</strong><div class="muted" style="font-size:12px;margin-top:4px">${c.hint || ""}</div>`;
    btn.onclick = ()=>{
      if(typeof c.effect === "function") c.effect(S);

      const next = (typeof c.to === "function") ? c.to(S) : c.to;
      if(typeof next === "string") go(next);
      else renderAll();
    };
    choices.appendChild(btn);
  });
}

function go(id){
  if(id==="__reset"){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    S = deepClone(DEFAULT);
    save();
    S = load() || deepClone(DEFAULT);
    bootNormalize();
    $("startScreen").classList.remove("hidden");
    $("sceneTitle").textContent = "";
    $("sceneText").textContent = "";
    $("combat").innerHTML = "";
    $("choices").innerHTML = "";
    renderStats();
    return;
  }

  // If next is normal scene, allow rare returned
  if(id && id.startsWith("s_")){
    maybeReturnedEvent(id);
    if(S.scene === "s_returned") return;
    S.scene = id;
    save();
    renderAll();
  }
}

/* Combat engine */
function parseDice(expr){
  const m = String(expr).trim().match(/^(\d+)d(\d+)([+-]\d+)?$/i);
  if(!m) return { total:0, detail:"0" };
  const n = parseInt(m[1],10);
  const d = parseInt(m[2],10);
  const mod = m[3] ? parseInt(m[3],10) : 0;
  let sum = 0;
  const rolls = [];
  for(let i=0;i<n;i++){
    const r = roll(d);
    rolls.push(r);
    sum += r;
  }
  const total = sum + mod;
  const detail = `${n}d${d}${mod? (mod>0? "+"+mod : mod) : ""} = [${rolls.join(", ")}]${mod? (mod>0? " + "+mod : " - "+Math.abs(mod)) : ""} => ${total}`;
  return { total, detail };
}

function startCombat(enemyId, returnScene){
  const e = ENEMIES[enemyId];
  if(!e) return;

  S.combat = {
    active:true,
    enemyId: enemyId,
    eHp: e.hp,
    eHpMax: e.hp,
    eAc: e.ac,
    eHit: e.hit,
    eDmg: e.dmg,
    eThreat: e.threat,
    guard:false,
    focus:0,
    returnScene: returnScene || S.scene,
    log:[`${e.desc}`, "", "Combat begins."]
  };

  save();
  renderAll();
}

function combatPush(line){
  if(!S.combat) return;
  S.combat.log.push(line);
  if(S.combat.log.length>120) S.combat.log.shift();
}

function renderCombatUI(){
  const c = S.combat;
  const e = ENEMIES[c.enemyId];
  const mount = $("combat");

  const pct = c.eHpMax<=0 ? 0 : Math.floor((c.eHp / c.eHpMax) * 100);
  const w = currentWeapon();
  const toHit = weaponToHit(w);

  mount.innerHTML = `
    <div class="card">
      <div class="enemyTop">
        <div class="row" style="gap:12px;align-items:flex-start">
          <div class="spriteBox" id="enemySprite"></div>
          <div>
            <div class="row" style="justify-content:space-between;align-items:center">
              <strong style="font-size:16px">${e.name}</strong>
              <span class="crit" id="critBadge">CRIT</span>
            </div>
            <div class="enemyMeta">HP ${c.eHp}/${c.eHpMax} | AC ${c.eAc} | Threat ${c.eThreat}</div>
            <div style="margin-top:8px" class="hpBar">
              <div class="hpFill danger" style="width:${pct}%"></div>
            </div>
            <div class="muted" style="font-size:12px;margin-top:8px">
              You: DMG ${w.dmg} | HIT ${toHit>=0? "+"+toHit:toHit} | DUR ${w.curDur}
            </div>
          </div>
        </div>
      </div>

      <div class="diceBox">
        <div class="die"><div class="lbl">Your d20</div><div class="num" id="dPlayer">-</div></div>
        <div class="die"><div class="lbl">Enemy d20</div><div class="num enemy" id="dEnemy">-</div></div>
        <div class="die"><div class="lbl">Last hit</div><div class="num good" id="dHit">-</div></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="smallBtn" id="btnAttack">Attack</button>
        <button class="smallBtn" id="btnFocus">Focus</button>
        <button class="smallBtn" id="btnGuard">Guard</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="muted" style="white-space:pre-wrap;font-size:12px;line-height:1.45" id="combatLog"></div>
      </div>
    </div>
  `;

  const spriteMount = $("enemySprite");
  window.renderEnemySprite(c.enemyId, spriteMount);

  const logEl = $("combatLog");
  logEl.textContent = c.log.slice(-18).join("\n");

  $("btnAttack").onclick = playerAttack;
  $("btnFocus").onclick = playerFocus;
  $("btnGuard").onclick = playerGuard;
}

function showCrit(){
  const b = $("critBadge");
  if(!b) return;
  b.classList.add("show");
  setTimeout(()=>b.classList.remove("show"), 520);
}

function playerAttack(){
  if(!S.combat) return;
  const c = S.combat;
  const e = ENEMIES[c.enemyId];

  const w = currentWeapon();
  decDur(w.id, 1);

  const nat = roll(20);
  animateNumber($("dPlayer"), nat, 420, 1, 20);

  if(nat === 1){
    combatPush("You roll a natural 1. MISS.");
    setStat("energy",-4);
    enemyTurn();
    endRound();
    return;
  }

  const crit = (nat === 20);
  if(crit) showCrit();

  const atk = nat + weaponToHit(w) + (c.focus*2) + Math.floor((S.resolve-50)/20);
  if(crit || atk >= c.eAc){
    const dmg = parseDice(w.dmg);
    const bonus = crit ? parseDice("1d6").total : 0;
    const total = dmg.total + bonus;

    c.eHp = Math.max(0, c.eHp - total);
    $("dHit").textContent = String(total);

    combatPush(`You roll ${nat}. Attack ${atk} vs AC ${c.eAc}. HIT.`);
    combatPush(`Damage: ${dmg.detail}${crit ? " | CRIT +1d6" : ""} => ${total}`);

    setStat("energy",-5);

    if(c.eHp <= 0){
      combatPush("Enemy dissolves into fog and silence.");
      endCombat(true);
      return;
    }

    enemyTurn();
    endRound();
  } else {
    combatPush(`You roll ${nat}. Attack ${atk} vs AC ${c.eAc}. MISS.`);
    setStat("energy",-4);
    enemyTurn();
    endRound();
  }
}

function playerFocus(){
  if(!S.combat) return;
  if(S.energy < 10){
    combatPush("Not enough energy to focus.");
    renderAll();
    return;
  }
  setStat("energy",-10);
  setStat("resolve",+6);
  S.combat.focus = clamp(S.combat.focus+1, 0, 3);
  combatPush(`You focus. Next attack gains +${S.combat.focus*2} to hit.`);
  enemyTurn();
  endRound();
}

function playerGuard(){
  if(!S.combat) return;
  S.combat.guard = true;
  setStat("energy",-6);
  setStat("resolve",+2);
  combatPush("You guard. Incoming damage reduced this round.");
  enemyTurn();
  endRound();
}

function enemyTurn(){
  if(!S.combat) return;
  const c = S.combat;
  const e = ENEMIES[c.enemyId];

  const nat = roll(20);
  animateNumber($("dEnemy"), nat, 420, 1, 20);

  const enemyAtk = nat + c.eHit + Math.floor((c.eThreat-2));
  const playerAC = 12 + Math.floor(S.resolve/25) + (c.guard ? 2 : 0);

  if(nat === 1){
    combatPush(`${e.name} rolls a natural 1. MISS.`);
    setStat("resolve", +1);
    c.guard = false;
    c.focus = 0;
    return;
  }

  const hit = (nat === 20) || (enemyAtk >= playerAC);
  if(hit){
    const dmg = parseDice(c.eDmg);
    let taken = dmg.total;
    if(c.guard) taken = Math.max(1, Math.floor(taken * 0.55));
    if(nat === 20) taken += parseDice("1d6").total;

    setStat("hp", -taken);
    setStat("resolve", -2);
    shakeStory();
    $("dHit").textContent = String(taken);

    combatPush(`${e.name} rolls ${nat}. Attack ${enemyAtk} vs your AC ${playerAC}. HIT.`);
    combatPush(`Damage: ${dmg.detail} | You take ${taken}.`);

    if(S.hp <= 0){
      combatPush("You collapse. Not dead. Rewritten.");
      S.hp = 35;
      S.energy = 25;
      S.resolve = clamp(S.resolve-12, 0, 100);
      endCombat(false);
      return;
    }
  } else {
    combatPush(`${e.name} rolls ${nat}. Attack ${enemyAtk} vs your AC ${playerAC}. MISS.`);
    setStat("resolve", +1);
  }

  c.guard = false;
  c.focus = 0;
}

function endRound(){
  save();
  renderAll();
}

function endCombat(victory){
  const c = S.combat;
  const e = ENEMIES[c.enemyId];

  if(victory){
    addLog(`You survived ${e.name}. The Bridge does not congratulate you.`);
    setStat("resolve", +6);
    setStat("energy", -3);

    // Drops
    const r = randInt(1,100);
    if(r<=18){
      gainSupply("salve",1,"You found salve in a crack of the stone. It smells like winter.");
    } else if(r<=38){
      gainSupply("water",1,"A flask. The water is still. That should not be possible.");
    } else if(r<=58){
      gainSupply("bread",1,"Bread appears where bread should not be. The Bridge is mocking you.");
    } else if(r<=70){
      gainWeapon("fog_dagger");
    } else if(r<=80){
      gainWeapon("stone_maul");
    } else if(r<=86){
      gainWeapon("glass_sabre");
    } else {
      addLog("Nothing useful remains, only the memory of impact.");
    }
  } else {
    addLog("You endured. The Bridge calls that enough.");
  }

  const next = c.returnScene || S.scene;
  S.combat = null;
  S.postCombat = {
    next: next,
    note: victory ? "You steady your breathing and move on." : "You crawl forward, refusing to stop."
  };

  save();
  renderAll();
}

/* Risky slip past */
function slipPast(){
  // d20 + resolve bonus vs threshold
  const d = roll(20);
  const total = d + Math.floor(S.resolve/15) - 2;
  addLog(`You attempt to slip past. Your body votes with a roll: ${d}.`);
  if(total >= 18){
    setStat("resolve", +6);
    setStat("energy", -4);
    addLog("You pass under the Warden's authority without being noticed.");
    go("s_final");
  } else {
    setStat("hp", -8);
    shakeStory();
    addLog("The Warden notices. The Bridge corrects your confidence.");
    startCombat("hollow_warden","s_final");
  }
}

/* Start screen buttons */
$("startBtn").addEventListener("click", ()=>{
  $("startScreen").classList.add("hidden");
  renderAll();
});
$("resetBtn").addEventListener("click", ()=>{
  go("__reset");
});

/* Boot render */
function renderAll(){
  renderStats();
  renderScene();
}

/* Start at intro screen, but keep state ready */
$("startScreen").classList.remove("hidden");
renderStats();

})();
</script>
  <script>
(function(){
"use strict";

/* PART 3: colored pixel art icons + enemy sprites + intro mobile fix */

/* Mobile intro title fix (safe-area friendly, works even if IDs differ) */
(function injectIntroFixCss(){
  const css = `
  /* Fix start intro title being clipped on mobile */
  #startScreen{
    padding-top: max(16px, env(safe-area-inset-top));
  }
  #startScreen h1,
  #startScreen .title,
  #startTitle{
    margin-top: 10px !important;
    padding-top: 6px !important;
    line-height: 1.08 !important;
  }
  /* extra breathing room above the intro text block */
  #startScreen .panel,
  #startScreen .card,
  #startScreen .startCard{
    margin-top: 12px !important;
  }
  `;
  const style = document.createElement("style");
  style.textContent = css;
  document.head.appendChild(style);
})();

/* Pixel art engine */
function makeSpriteCanvas(map, palette, scale, bg){
  const h = map.length;
  const w = map[0].length;
  const c = document.createElement("canvas");
  c.width = w * scale;
  c.height = h * scale;

  const ctx = c.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  if(bg){
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,c.width,c.height);
  }

  for(let y=0;y<h;y++){
    const row = map[y];
    for(let x=0;x<w;x++){
      const k = row[x];
      const col = palette[k];
      if(!col) continue;
      ctx.fillStyle = col;
      ctx.fillRect(x*scale, y*scale, scale, scale);
    }
  }

  c.style.imageRendering = "pixelated";
  c.style.display = "block";
  return c;
}

function framedIcon(node){
  const wrap = document.createElement("div");
  wrap.style.width = "34px";
  wrap.style.height = "34px";
  wrap.style.borderRadius = "10px";
  wrap.style.border = "1px solid rgba(255,255,255,.12)";
  wrap.style.background = "rgba(0,0,0,.18)";
  wrap.style.display = "grid";
  wrap.style.placeItems = "center";
  wrap.style.overflow = "hidden";
  wrap.appendChild(node);
  return wrap;
}

/* Palettes */
const PAL = {
  metal:"#cbd5e1",
  metal2:"#94a3b8",
  dark:"#0b1220",
  outline:"#0a0f1a",
  gold:"#fbbf24",
  gold2:"#f59e0b",
  red:"#fb7185",
  red2:"#ef4444",
  blue:"#60a5fa",
  teal:"#22d3ee",
  wood:"#a16207",
  wood2:"#854d0e",
  bone:"#f1f5f9",
  mist:"#d8b4fe",
  mist2:"#a78bfa",
  green:"#34d399",
  glass:"#93c5fd",
  glass2:"#e0f2fe",
  ink:"#111827"
};

/* Weapon icon maps (16x16) */
const WEAPON_SPRITES = {
  iron_sword:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal, "s":PAL.metal2, "g":PAL.gold, "h":PAL.gold2, "b":PAL.blue },
    map:[
      ".......oo.......",
      "......ommo......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      ".......oo.......",
      ".....ohggho.....",
      "......oggo......",
      "......obb o.....".replace(" ","."),
      "......obbo......",
      "......oooo......"
    ]
  },
  oak_club:{
    pal:{ ".":null, "o":PAL.outline, "w":PAL.wood, "v":PAL.wood2, "g":PAL.green },
    map:[
      "................",
      ".......oo.......",
      "......owwo......",
      "......owwo......",
      "......owwo......",
      "......owwo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      ".....ogvvo......",
      "......oo........",
      "................"
    ]
  },
  chipped_spear:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal, "s":PAL.metal2, "w":PAL.wood, "v":PAL.wood2, "b":PAL.blue },
    map:[
      ".......oo.......",
      "......ommo......",
      ".....omssmo.....",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......ovvo......",
      "......obbo......",
      ".......oo......."
    ]
  },
  river_knife:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal, "s":PAL.metal2, "b":PAL.blue, "g":PAL.gold2 },
    map:[
      "................",
      ".......oo.......",
      "......ommo......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      ".......oo.......",
      ".....oggggo.....",
      "......obbo......",
      "......obbo......",
      ".......oo.......",
      "................",
      "................",
      "................"
    ]
  },
  fog_dagger:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal, "s":PAL.metal2, "p":PAL.mist, "q":PAL.mist2 },
    map:[
      "................",
      ".......oo.......",
      "......ommo......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      "......omso......",
      ".......oo.......",
      ".....oqqqqo.....",
      "......oppo......",
      "......oppo......",
      ".......oo.......",
      "................",
      "................",
      "................"
    ]
  },
  stone_maul:{
    pal:{ ".":null, "o":PAL.outline, "s":PAL.metal2, "m":PAL.metal, "w":PAL.wood, "v":PAL.wood2 },
    map:[
      "......oooo......",
      ".....osssso.....",
      ".....osmmso.....",
      ".....osssso.....",
      "......oooo......",
      ".......ov.......",
      ".......ov.......",
      ".......ov.......",
      ".......ov.......",
      ".......ov.......",
      ".......ov.......",
      "......ovv.......",
      "......ovv.......",
      "......ovv.......",
      ".......oo.......",
      "................"
    ]
  },
  glass_sabre:{
    pal:{ ".":null, "o":PAL.outline, "g":PAL.glass, "h":PAL.glass2, "m":PAL.metal2, "p":PAL.mist2 },
    map:[
      ".......oo.......",
      "......oggo......",
      "......ohho......",
      "......ohho......",
      "......ohho......",
      "......ohho......",
      "......ohho......",
      "......ohho......",
      "......oggo......",
      ".......oo.......",
      ".....oppppo.....",
      "......ommo......",
      ".......oo.......",
      "................",
      "................",
      "................"
    ]
  },
  council_needle:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal2, "i":PAL.ink, "g":PAL.gold, "r":PAL.red },
    map:[
      ".......oo.......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      ".......oo.......",
      ".....oggggo.....",
      "......or ro......".replace(" ","."),
      "......oiio......",
      ".......oo.......",
      "................"
    ]
  },
  bridgeheart_relic:{
    pal:{ ".":null, "o":PAL.outline, "g":PAL.gold, "h":PAL.gold2, "m":PAL.metal, "b":PAL.blue, "r":PAL.red2 },
    map:[
      ".......oo.......",
      "......oggo......",
      ".....oghhgo.....",
      "......oggo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      "......ommo......",
      ".......oo.......",
      ".....obbbbo.....",
      "......or ro......".replace(" ","."),
      "......oggo......",
      ".......oo.......",
      "................"
    ]
  }
};

/* Enemy sprites (24x24) */
const ENEMY_SPRITES = {
  batling:{
    pal:{ ".":null, "o":PAL.outline, "r":PAL.red2, "p":PAL.red, "m":PAL.metal2, "e":"#fde68a" },
    map:[
      "........................",
      "..........oooo..........",
      ".........orrrro.........",
      "....oooo.orpppro.oooo...",
      "...orrrroorppproorrrro..",
      "..orppproorrrroorpppro..",
      "..orpppro.oooo.orpppro..",
      "...orrrro..oo..orrrro...",
      "....oooo..orr..oooo.....",
      "..........orrro..........",
      "..........orrro..........",
      ".........oerr eo.........".replace(" ","."),
      ".........oerr eo.........".replace(" ","."),
      "..........orrro..........",
      "..........o..o..........",
      ".........oo..oo.........",
      "........o......o........",
      "........o......o........",
      ".........oo..oo.........",
      "..........oooo..........",
      "........................",
      "........................",
      "........................",
      "........................"
    ]
  },
  mist_mirror:{
    pal:{ ".":null, "o":PAL.outline, "p":PAL.mist2, "q":PAL.mist, "b":PAL.blue, "i":PAL.ink },
    map:[
      "........................",
      ".........oooooo.........",
      ".......ooqqqqqqoo.......",
      "......oqpppppppqo......",
      ".....oqpbbbbbbpq o.....".replace(" ","."),
      ".....oqpbiiii bqo......".replace(" ","."),
      ".....oqpbiiii bqo......".replace(" ","."),
      ".....oqpbbbbbbpqo......",
      "......oqpppppppqo......",
      ".......ooqqqqqqoo.......",
      ".........oooooo.........",
      "............oo..........",
      ".........oooooo.........",
      ".......ooqqqqqqoo.......",
      "......oqpppppppqo......",
      ".....oqpbbbbbbpqo......",
      ".....oqpbiiii bqo......".replace(" ","."),
      ".....oqpbiiii bqo......".replace(" ","."),
      ".....oqpbbbbbbpqo......",
      "......oqpppppppqo......",
      ".......ooqqqqqqoo.......",
      ".........oooooo.........",
      "........................",
      "........................"
    ]
  },
  hollow_warden:{
    pal:{ ".":null, "o":PAL.outline, "m":PAL.metal, "s":PAL.metal2, "g":PAL.gold2, "i":PAL.ink, "r":PAL.red2 },
    map:[
      "........................",
      "..........oooo..........",
      ".........ommmmo.........",
      "........omssssmo........",
      "........omsii smo........".replace(" ","."),
      "........omsii smo........".replace(" ","."),
      "........omssssmo........",
      ".........ommmmo.........",
      "......ooooommmmooooo....",
      ".....ommmmsssssmmmmmo...",
      "....omssssoooooosssmo...",
      "....omssooggggooossmo...",
      "....omssoogrrgooossmo...",
      "....omssooggggooossmo...",
      "....omssssoooooosssmo...",
      ".....ommmmsssssmmmmmo...",
      "......ooooommmmooooo....",
      "..........ommmmo.........",
      ".........omssssmo........",
      ".........omssssmo........",
      "..........ommmmo.........",
      "...........oooo..........",
      "........................",
      "........................"
    ]
  },
  stone_scribe:{
    pal:{ ".":null, "o":PAL.outline, "s":PAL.metal2, "b":PAL.bone, "i":PAL.ink, "g":PAL.gold, "w":PAL.wood2 },
    map:[
      "........................",
      "..........oooo..........",
      ".........osssso.........",
      "........osbbbbso........",
      "........osbii bso........".replace(" ","."),
      "........osbii bso........".replace(" ","."),
      "........osbbbbso........",
      ".........osssso.........",
      "..........oooo..........",
      ".......ooooosoooo.......",
      "......osssssssssso......",
      ".....ossssoooooosso.....",
      ".....osssowwwwwwosso.....",
      ".....osssowg g wosso.....".replace(" ","."),
      ".....osssowwwwwwosso.....",
      ".....ossssoooooosso.....",
      "......osssssssssso......",
      ".......ooooosoooo.......",
      "...........oo...........",
      "...........oo...........",
      "..........oooo..........",
      "........................",
      "........................",
      "........................"
    ]
  }
};

/* Override the stubs from Part 2 with real colored pixel art */
window.renderWeaponIcon = function(weaponId){
  const s = WEAPON_SPRITES[weaponId] || WEAPON_SPRITES.iron_sword;
  const canvas = makeSpriteCanvas(s.map, s.pal, 2, null);
  canvas.style.width = "28px";
  canvas.style.height = "28px";
  return framedIcon(canvas);
};

window.renderEnemySprite = function(enemyId, mount){
  mount.innerHTML = "";
  const s = ENEMY_SPRITES[enemyId] || ENEMY_SPRITES.batling;

  const canvas = makeSpriteCanvas(s.map, s.pal, 2, "rgba(0,0,0,.18)");
  canvas.style.width = "92px";
  canvas.style.height = "92px";
  canvas.style.borderRadius = "10px";
  canvas.style.border = "1px solid rgba(255,255,255,.10)";
  canvas.style.boxShadow = "0 10px 24px rgba(0,0,0,.25)";
  mount.appendChild(canvas);
};

})();
</script>


</body>
</html>
